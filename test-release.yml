resources:
  repositories:
    - repository: 1es
      type: git
      name: 1ESPipelineTemplates/1ESPipelineTemplates
      ref: refs/tags/release

extends:
  template: v1/1ES.Unofficial.PipelineTemplate.yml@1es
  parameters:
    pool:
      name: 1es-pool-azfunc
      image: 1es-windows-2022
      os: windows
    stages:
      - stage: Approval
        displayName: "Notify and Manual Approval"
        jobs:
          - job: ApprovalJob
            displayName: "Approval Job"
            pool: server # Configures the job to be agentless
            steps:
              # Manual Intervention
              - task: ManualValidation@1
                displayName: "Await Manual Approval"
                inputs:
                  notifyUsers: $(userlist)
                  instructions: "Please review the release details and approve to continue. Contact $(userlist) for assistance."
                  onTimeout: "reject"
                  timeout: "172800" # 2 days in seconds
                  approvers: 

      - stage: Release
        jobs:
          - job: Release
            displayName: Publish Release Artifacts
            templateContext:
              type: releaseJob  # Required, this indicates this job is a release job
              isProduction: false  # Required, must be 'true' or 'false'
              #inputs:  # All input build artifacts must be declared here
               #- input: pipelineArtifact  # Required, type of the input artifact
                #artifactName: WebApp  # Required, name of the pipeline artifact
                #targetPath: $(Pipeline.Workspace)/drop  # Optional, specifies where the artifact is downloaded
            steps:
              # Notify Teams via Webhook
              - pwsh: |
                  $payload = @{
                      text = "A manual approval is required for the pipeline to continue. Please review the release details and approve."
                  } | ConvertTo-Json -Depth 10
                  Invoke-RestMethod -Uri $env:webhookUrl -Method Post -Body $payload -ContentType "application/json"
                env:
                    webhookUrl: $(Webhook)
              - task: GitHubRelease@1
                inputs:
                  gitHubConnection: Azure
                  repositoryName: "Azure/azure-functions-integration-tests"
                  action: "create"
                  target: "744b10576ab340695fb14fc0d99b4b57b8a17989"
                  tagSource: "userSpecifiedTag"
                  tag: "v4.636.0"
                  title: "4.636.0"
                  releaseNotesSource: "inline"
                  releaseNotesInline: |
                    ### Release notes
                    <!-- Please add your release notes in the following format:
                    - My change description (#PR)
                    -->
                    - Updated System.Memory.Data reference to 6.0.0 and 8.0.1 for .NET 6 and .NET 8, respectively.
                    - Update Python Worker Version to *An external link was removed to protect your privacy.*
                    - Added fallback behavior to ensure in-proc payload compatibility with "dotnet-isolated" as the `FUNCTIONS_WORKER_RUNTIME` value (#10439)
                    - Update Node.js Worker Version to *An external link was removed to protect your privacy.*
                    - Implement host configuration property to allow configuration of the metadata provider timeout period (#10526)
                    - The value can be set via `metadataProviderTimeout` in host.json and defaults to "00:00:30" (30 seconds).
                    - For logic apps, unless configured via the host.json, the timeout is disabled by default.
                    - Added support for identity-based connections to Diagnostic Events (#10438)
                    - Update PowerShell 7.2 worker to *An external link was removed to protect your privacy.*
                    - Update PowerShell 7.4 worker to *An external link was removed to protect your privacy.*
                    - Do not unregister gRPC extension endpoints on host shutdown.
                    - Updated System.Memory.Data reference to 6.0.0 and 8.0.1 for .NET 6 and .NET 8, respectively.
                  assets: "$(Build.ArtifactStagingDirectory)/*.zip"
                  isDraft: false
                  isPreRelease: false
                  addChangeLog: false
                  changeLogCompareToRelease: "lastFullRelease"
                  changeLogType: "commitBased"